name: Deploy

on:
  push:
    branches: [main]
  release:
    types: [published]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: staging
      url: https://staging.red-potato.example.com
    permissions:
      contents: read
      packages: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: 'v3.13.0'

      - name: Configure kubectl
        uses: azure/k8s-set-context@v3
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.STAGING_KUBECONFIG }}

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get image tag
        id: image-tag
        run: echo "tag=sha-$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Deploy to Staging with Helm
        id: helm-deploy
        run: |
          helm upgrade --install red-potato ./helm/red-potato \
            --namespace red-potato-staging \
            --create-namespace \
            --set backend.image.repository=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/backend \
            --set backend.image.tag=${{ steps.image-tag.outputs.tag }} \
            --set frontend.image.repository=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/frontend \
            --set frontend.image.tag=${{ steps.image-tag.outputs.tag }} \
            --set ingress.enabled=true \
            --set ingress.hosts[0].host=staging.red-potato.example.com \
            --set ingress.hosts[0].paths[0].path=/ \
            --set ingress.hosts[0].paths[0].pathType=Prefix \
            --values ./helm/red-potato/values-staging.yaml \
            --wait \
            --timeout 5m \
            --atomic

      - name: Verify deployment
        run: |
          kubectl rollout status deployment/red-potato-backend -n red-potato-staging --timeout=3m
          kubectl rollout status deployment/red-potato-frontend -n red-potato-staging --timeout=3m

      - name: Rollback on failure
        if: failure() && steps.helm-deploy.outcome == 'failure'
        run: |
          echo "Deployment failed, initiating rollback..."
          helm rollback red-potato -n red-potato-staging
          echo "Rollback completed"

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: github.event_name == 'release' && github.event.action == 'published'
    environment:
      name: production
      url: https://red-potato.example.com
    permissions:
      contents: read
      packages: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: 'v3.13.0'

      - name: Configure kubectl
        uses: azure/k8s-set-context@v3
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.PRODUCTION_KUBECONFIG }}

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get release version
        id: release-version
        run: echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Deploy to Production with Helm
        id: helm-deploy
        run: |
          helm upgrade --install red-potato ./helm/red-potato \
            --namespace red-potato-production \
            --create-namespace \
            --set backend.image.repository=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/backend \
            --set backend.image.tag=${{ steps.release-version.outputs.version }} \
            --set frontend.image.repository=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/frontend \
            --set frontend.image.tag=${{ steps.release-version.outputs.version }} \
            --set ingress.enabled=true \
            --set ingress.hosts[0].host=red-potato.example.com \
            --set ingress.hosts[0].paths[0].path=/ \
            --set ingress.hosts[0].paths[0].pathType=Prefix \
            --values ./helm/red-potato/values-production.yaml \
            --wait \
            --timeout 10m \
            --atomic

      - name: Verify deployment
        run: |
          kubectl rollout status deployment/red-potato-backend -n red-potato-production --timeout=5m
          kubectl rollout status deployment/red-potato-frontend -n red-potato-production --timeout=5m

      - name: Rollback on failure
        if: failure() && steps.helm-deploy.outcome == 'failure'
        run: |
          echo "Deployment failed, initiating rollback..."
          helm rollback red-potato -n red-potato-production
          echo "Rollback completed"

      - name: Create deployment summary
        if: success()
        run: |
          echo "## Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.release-version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: Production" >> $GITHUB_STEP_SUMMARY
          echo "- **Namespace**: red-potato-production" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: https://red-potato.example.com" >> $GITHUB_STEP_SUMMARY
